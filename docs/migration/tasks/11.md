Задача 6 (обновленная): Обновить api/dependencies.py, использовать common. (Детализация)
Цель: Обновить зависимости API для инъекции новых сервисов (DatabaseManager, CheckerClient, AnswerService, QuizService и т.д.).

Действия:

Копирование api/dependencies.py в web-api-service:
Команда: cp api/dependencies.py web-api-service/api/

# Было (или что-то подобное):
# from utils.database_manager import DatabaseManager
# from services.answer_service import AnswerService
# from services.quiz_service import QuizService
# from utils.answer_checker import FIPIAnswerChecker
# from utils.browser_manager import BrowserManager
# from utils.retriever import QdrantProblemRetriever # Если использовалось напрямую
# from clients.checker_client import CheckerClient # Если уже был
# from clients.search_client import SearchClient # Если уже был
# from services.specification import SpecificationService
# from utils.skill_graph import InMemorySkillGraph
# from utils.task_number_inferer import TaskNumberInferer
# from models.pydantic_models import ... # Если использовались схемы

# Стало:
from fastapi import Depends, HTTPException, status
from web_api_service.database.database_manager import DatabaseManager # Импортируем из web-api-service
from web_api_service.services.answer_service import AnswerService # Импортируем из web-api-service
from web_api_service.services.quiz_service import QuizService # Импортируем из web-api-service
from web_api_service.clients.checker_client import CheckerClient # Импортируем из web-api-service
from web_api_service.clients.search_client import SearchClient # Импортируем из web-api-service
# from common.clients.problem_retriever import QdrantProblemRetriever # Если QdrantProblemRetriever и его зависимости (qdrant-client) остаются в web-api (не рекомендуется)
from common.services.specification import SpecificationService # Импортируем из common
from common.utils.skill_graph import InMemorySkillGraph # Импортируем из common
from common.utils.task_number_inferer import TaskNumberInferer # Импортируем из common
from common.models.pydantic_models import User # Импортируем схемы из common, если используются
# ... другие импорты из common и web-api-service
import os
import logging

logger = logging.getLogger(__name__)

# Зависимость для получения DatabaseManager
async def get_db_manager() -> DatabaseManager:
    # Используем URL из переменной окружения
    database_url = os.getenv("SUPABASE_DATABASE_URL") # Или DATABASE_URL
    if not database_url:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="Database URL not configured")
    return DatabaseManager(database_url)

# Зависимость для получения CheckerClient
async def get_checker_client() -> CheckerClient:
    base_url = os.getenv("CHECKER_SERVICE_URL")
    if not base_url:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="Checker Service URL not configured")
    return CheckerClient(base_url=base_url)

# Зависимость для получения SearchClient
async def get_search_client() -> SearchClient:
    base_url = os.getenv("SEARCH_SERVICE_URL") # или QDRANT_URL, если прямое подключение
    if not base_url:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="Search Service URL not configured")
    return SearchClient(base_url=base_url)

# Зависимость для получения AnswerService
async def get_answer_service(
    db: DatabaseManager = Depends(get_db_manager),
    checker_client: CheckerClient = Depends(get_checker_client)
) -> AnswerService:
    return AnswerService(db_manager=db, checker_client=checker_client)

# Зависимость для получения QuizService
async def get_quiz_service(
    db: DatabaseManager = Depends(get_db_manager),
    search_client: SearchClient = Depends(get_search_client), # или QdrantProblemRetriever
    spec_service: SpecificationService = Depends(get_spec_service), # Предполагаем, что get_spec_service определена
    skill_graph: InMemorySkillGraph = Depends(get_skill_graph), # Предполагаем, что get_skill_graph определена
    task_inferer: TaskNumberInferer = Depends(get_task_number_inferer) # Предполагаем, что get_task_number_inferer определена
) -> QuizService:
    return QuizService(
        db_manager=db,
        search_client=search_client, # или problem_retriever
        spec_service=spec_service,
        skill_graph=skill_graph,
        task_inferer=task_inferer
    )

# ... другие зависимости ...

# Пример зависимостей для common компонентов (если нужно инжектировать их напрямую)
def get_spec_service() -> SpecificationService:
    # subject_mapping = get_subject_mapping() # Если нужно
    # specification_path = os.getenv("SPECIFICATION_PATH", "config/specification.json") # Пример
    # return SpecificationService.from_file(specification_path)
    pass # Реализуйте

def get_skill_graph() -> InMemorySkillGraph:
    # Возвращает новый инстанс или из пула, в зависимости от логики
    return InMemorySkillGraph()

def get_task_number_inferer() -> TaskNumberInferer:
    rules_path = os.getenv("TASK_NUMBER_RULES_PATH", "config/task_number_rules.json") # Пример
    return TaskNumberInferer.from_file(rules_path)

# Зависимость для проверки подписки (из задачи 17)
async def require_subscription(db: DatabaseManager = Depends(get_db_manager), user_id: int = Depends(get_current_user_id)) -> bool:
    # subscription = await db.get_user_subscription_status(user_id) # Предполагаем, что метод есть
    # if not subscription or subscription.status != "active":
    #    raise HTTPException(status_code=status.HTTP_402_PAYMENT_REQUIRED, detail="Subscription required")
    # return True
    pass # Реализуйте

# get_current_user_id: Реализуйте аутентификацию JWT/сессии
async def get_current_user_id() -> int:
    # Извлеките user_id из токена/сессии
    # return user_id
    pass # Заглушка

Копирование common в web-api-service (если не копируется в Dockerfile):
Команда: cp -r common web-api-service/
Acceptance:

Файл web-api-service/api/dependencies.py обновлен.
Он импортирует DatabaseManager, AnswerService, QuizService, CheckerClient, SearchClient из web-api-service.
Он импортирует SpecificationService, InMemorySkillGraph, TaskNumberInferer из common.
Он определяет зависимости get_db_manager, get_checker_client, get_search_client, get_answer_service, get_quiz_service, get_spec_service, get_skill_graph, get_task_number_inferer.
Зависимости корректно инжектируют экземпляры соответствующих классов, используя другие зависимости.

*   **Задача 6 (обновленная): Обновить `api/dependencies.py`.**
    *   **Дополнительное действие:** После обновления `api/dependencies.py`:
        *   **Тесты (Unit):** `web-api-service/tests/unit/test_api/test_dependencies.py`
            *   Проверить, что `get_db_manager`, `get_checker_client`, `get_search_client`, `get_answer_service`, `get_quiz_service` корректно создают и возвращают экземпляры с правильными параметрами (например, через моки).
        *   **Acceptance:** `api/dependencies.py` покрыт юнит-тестами.

