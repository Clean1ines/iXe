#### **Задача 3 (обновленная): Создать `checker-service` (файлы типа `answer_checker.py` и `browser_manager.py` не из `common`) (Детализация)**

**Цель:** Вынести логику проверки ответов в отдельный сервис, изолировав `playwright`.

**Действия:**

1.  **Создание структуры `checker-service`:**
    *   **Команда:** `mkdir -p checker-service/{api,services,utils,models}`

2.  **Копирование файлов в `checker-service`:**
    *   **`services/answer_checker.py`:** Основная логика проверки.
        *   **Команда:** `cp utils/answer_checker.py checker-service/services/` (предполагая, что он был перемещен в `services` в оригинальном проекте, иначе `cp utils/answer_checker.py checker-service/services/`).
        *   **Обновление импортов:** Заменить `from utils.browser_manager import BrowserManager` на `from utils.browser_manager import BrowserManager` (копия в `checker-service`). Заменить `from utils.subject_mapping import get_proj_id_for_subject` на `from common.utils.subject_mapping import get_proj_id_for_subject`.
    *   **`utils/browser_manager.py`, `utils/browser_pool_manager.py`:** Управление браузером.
        *   **Команды:**
            ```bash
            cp utils/browser_manager.py checker-service/utils/
            cp utils/browser_pool_manager.py checker-service/utils/
            ```
        *   **Обновление импортов:** Заменить `from utils.subject_mapping import get_proj_id_for_subject` на `from common.utils.subject_mapping import get_proj_id_for_subject`.
    *   **`utils/subject_mapping.py`:** *Только если* она *не была* перемещена в `common`. Если *была*, импортируйте из `common`.
        *   **Команда:** `cp utils/subject_mapping.py checker-service/utils/` (только если *не* в `common`).

3.  **Создание `requirements_checking.txt` для `checker-service`:**
    *   **Команда:** `cp requirements_checking.txt checker-service/`
    *   Убедитесь, что он содержит `fastapi`, `uvicorn`, `playwright`, `python-dotenv`, `pydantic`.
    *   Убедитесь, что он *не* содержит `sqlalchemy`, `asyncpg`, `qdrant-client`.

4.  **Создание `Dockerfile.checker`:**
    *   **Команда:** `touch checker-service/Dockerfile.checker`
    *   **Содержимое `Dockerfile.checker`:**
        ```dockerfile
        # --- STAGE 1: Builder ---
        FROM python:3.11-slim as builder

        RUN apt-get update && apt-get install -y --no-install-recommends \
            build-essential \
            gcc \
            g++ \
            && rm -rf /var/lib/apt/lists/*

        WORKDIR /app

        COPY requirements_checking.txt .
        RUN pip install --user --no-cache-dir -r requirements_checking.txt
        RUN pip cache purge # В builder стадии

        # --- STAGE 2: Runtime ---
        FROM python:3.11-slim as runtime

        RUN apt-get update && apt-get install -y --no-install-recommends \
            ca-certificates \
            fonts-liberation \
            libappindicator3-1 \
            libasound2 \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libc6 \
            libcairo2 \
            libcups2 \
            libdbus-1-3 \
            libexpat1 \
            libfontconfig1 \
            libgbm1 \
            libgcc1 \
            libglib2.0-0 \
            libgtk-3-0 \
            libnspr4 \
            libnss3 \
            libpango-1.0-0 \
            libpangocairo-1.0-0 \
            libstdc++6 \
            libx11-6 \
            libx11-xcb1 \
            libxcb1 \
            libxcomposite1 \
            libxcursor1 \
            libxdamage1 \
            libxext6 \
            libxfixes3 \
            libxi6 \
            libxrandr2 \
            libxrender1 \
            libxss1 \
            libxtst6 \
            wget \
            xdg-utils \
            && rm -rf /var/lib/apt/lists/*

        WORKDIR /app

        COPY --from=builder /root/.local /root/.local
        ENV PATH=/root/.local/bin:$PATH

        RUN playwright install chromium

        # Копирование common/ библиотеки (если используются какие-то общие схемы Pydantic, например)
        COPY common /app/common
        RUN pip install --user --no-cache-dir /app/common

        # Копирование кода checker-service
        COPY checker-service/ /app/

        # CMD для запуска FastAPI API проверки
        CMD ["python", "-m", "uvicorn", "api.app:app", "--host", "0.0.0.0", "--port", "10000"]
        ```

5.  **Создание `.dockerignore` для `checker-service`:**
    *   **Команда:** `touch checker-service/.dockerignore`
    *   **Содержимое:** Аналогично другим сервисам, исключая другие сервисы.

**Acceptance:**

*   Папка `checker-service` создана.
*   Файлы, специфичные для проверки, скопированы.
*   Импорты в скопированных файлах обновлены (включая `common` для `subject_mapping`, если она там).
*   `requirements_checking.txt` находится в `checker-service` и содержит правильные зависимости.
*   `Dockerfile.checker` находится в `checker-service`, использует `requirements_checking.txt`, `common/` (если нужно), устанавливает `playwright`, и имеет корректный `CMD`.

---

*   **Задача 3 (обновленная): Создать `checker-service`.**
    *   **Дополнительное действие:** После копирования файлов и обновления импортов в `checker-service`:
        *   Создать `checker-service/tests/` с подпапками `unit/`, `integration/`.
        *   **Тесты (Unit):**
            *   `checker-service/tests/unit/test_answer_checker.py`: Мокировать `BrowserManager`. Проверить логику `check_answer`.
            *   `checker-service/tests/unit/test_browser_manager.py`: *Опционально.* Сложно тестировать реальный браузер. Сфокусироваться на логике `get_page`, `close`. Мокировать `playwright`.
        *   **Тесты (Integration):**
            *   `checker-service/tests/integration/test_answer_checking_api.py`: Использовать `TestClient` из `fastapi.testclient`. Мокировать `BrowserManager`. Проверить эндпоинт `/check_answer`.
    *   **Acceptance:** `checker-service` имеет юнит- и интеграционные тесты.

Задача 3 (обновленная): Создать checker-service.
Дополнительное действие (Документирование):
Создать checker-service/README.md: Описание сервиса, его назначение, зависимости (requirements_checking.txt), структура (Dockerfile.checker, services/, utils/), как запустить локально, как запустить тесты.
Создать docs/adr/005-checker-service-architecture.md: ADR для архитектуры checker-service (использование BrowserManager, playwright, изоляция от web-api).
Создать docs/api/checker-service-openapi.json (если делаете API): Описание API checker-service (эндпоинт /check_answer).
Acceptance (Документирование):
У checker-service есть собственный README.md.
Существует ADR для архитектуры checker-service.
(Опционально) Существует OpenAPI-спецификация для API checker-service.

Задача 3 (обновленная): Создать checker-service.
Дополнительное действие (Инженерия требований):
Создать docs/requirements/REQ-007-Checker-Service.md:
ID: REQ-007
Тип: Функциональное требование + Архитектурное требование.
Требование: "Сервис проверки ответов должен принимать task_id и user_answer, использовать playwright для проверки ответа на официальном сайте FIPI, и возвращать результат. Он должен изолироваться от веб-API."
Обоснование: Обеспечить проверку ответов без нагружения веб-API playwright.
Критерии приемки: checker-service запускается, принимает запросы, использует playwright для проверки, возвращает корректный ответ.
Связанные ADR: docs/adr/005-checker-service-architecture.md.
Acceptance (Инженерия требований):
Существует формализованное требование REQ-007 для checker-service.

Задача 3 (обновленная): Создать checker-service.
Дополнительное действие (Тестирование требований):
Создать tests/requirements/test_req_007_checker_service.py:
Тест: test_checker_service_uses_playwright_isolated()
Цель: Проверить, что checker-service содержит playwright в своих зависимостях (requirements_checking.txt) и не использует его в web-api-service.
Метод: Прочитать checker-service/requirements_checking.txt (проверить наличие playwright), прочитать web-api-service/requirements_web.txt (проверить отсутствие playwright).
Связь с требованием: Покрывает REQ-007.
Acceptance (Тестирование требований):
Существует тест, проверяющий выполнение REQ-007.


*   **Задача 3 (обновленная): Создать `checker-service`.**
    *   **Дополнительное действие (DevEx):**
        *   **Создать `checker-service/README.md`:** Аналогично.
        *   **Обновить общий `Makefile`:** Добавить команды `test-checker`, `run-checker-local` (если применимо).
    *   **Acceptance (DevEx):**
        *   У `checker-service` есть собственный `README.md` с инструкциями для разработчика.
        *   Есть удобные команды в `Makefile` для работы с `checker-service`.