


#### **Задача 12 (обновленная): Создать `indexer-service` с использованием `common/` (Детализация)**

**Цель:** Вынести логику индексации задач в Qdrant в отдельный сервис, изолировав `qdrant-client` и используя `common`.

**Действия:**

1.  **Создание структуры `indexer-service`:**
    *   **Команда:** `mkdir -p indexer-service/{api,scripts,utils,models}`

2.  **Копирование файлов в `indexer-service`:**
    *   **`scripts/index_problems.py`:** Основной скрипт индексации.
        *   **Команда:** `cp scripts/index_problems.py indexer-service/scripts/`
        *   **Обновление импортов:** Заменить `from utils.vector_indexer import QdrantProblemIndexer` на `from utils.vector_indexer import QdrantProblemIndexer` (копия в `indexer-service`). Заменить `from utils.database_manager import DatabaseManager` на `from common.utils.database_manager import DatabaseManager` (если `DatabaseManager` в `common` для чтения задач). Заменить `from models.problem_schema import Problem` на `from common.models.problem_schema import Problem`.
    *   **`utils/vector_indexer.py`:** Логика индексации.
        *   **Команда:** `cp utils/vector_indexer.py indexer-service/utils/`
        *   **Обновление импортов:** Заменить `from models.problem_schema import Problem` на `from common.models.problem_schema import Problem`. Заменить `from utils.model_adapter import db_problem_to_problem` на `from common.utils.model_adapter import db_problem_to_problem`.

3.  **Создание `requirements_indexing.txt` для `indexer-service`:**
    *   **Команда:** `cp requirements_indexing.txt indexer-service/`
    *   Убедитесь, что он содержит `qdrant-client`, `sqlalchemy`, `asyncpg`, `pydantic`, `python-dotenv`.
    *   Убедитесь, что он *не* содержит `fastapi`, `uvicorn`, `playwright`.

4.  **Создание `Dockerfile.indexer`:**
    *   **Команда:** `touch indexer-service/Dockerfile.indexer`
    *   **Содержимое `Dockerfile.indexer`:**
        ```dockerfile
        # --- STAGE 1: Builder ---
        FROM python:3.11-slim as builder

        RUN apt-get update && apt-get install -y --no-install-recommends \
            build-essential \
            gcc \
            g++ \
            && rm -rf /var/lib/apt/lists/*

        WORKDIR /app

        COPY requirements_indexing.txt .
        RUN pip install --user --no-cache-dir -r requirements_indexing.txt
        RUN pip cache purge # В builder стадии

        # --- STAGE 2: Runtime ---
        FROM python:3.11-slim as runtime

        WORKDIR /app

        COPY --from=builder /root/.local /root/.local
        ENV PATH=/root/.local/bin:$PATH

        # Копирование common/ библиотеки
        COPY common /app/common
        RUN pip install --user --no-cache-dir /app/common

        # Копирование кода indexer-service
        COPY indexer-service/ /app/

        # CMD для запуска скрипта индексации или API
        # CMD ["python", "scripts/index_problems.py"]
        CMD ["python", "-m", "uvicorn", "api.app:app", "--host", "0.0.0.0", "--port", "10000"] # Если делаете API
        ```

5.  **Создание `.dockerignore` для `indexer-service`:**
    *   **Команда:** `touch indexer-service/.dockerignore`
    *   **Содержимое:** Аналогично `scraper-service`, исключая `web-api-service`, `scraper-service`, `checker-service`, `search-service`, и т.д.

**Acceptance:**

*   Папка `indexer-service` создана.
*   Файлы, специфичные для индексации, скопированы.
*   Импорты в скопированных файлах обновлены для использования `common/`.
*   `requirements_indexing.txt` находится в `indexer-service` и содержит правильные зависимости.
*   `Dockerfile.indexer` находится в `indexer-service`, использует `requirements_indexing.txt`, `common/`, и имеет корректный `CMD`.

---
*   **Задача 12 (обновленная): Создать `indexer-service` с использованием `common/`.**
    *   **Дополнительное действие:** После копирования файлов и обновления импортов в `indexer-service`:
        *   Создать `indexer-service/tests/` с подпапками `unit/`, `integration/`.
        *   **Тесты (Unit):**
            *   `indexer-service/tests/unit/test_vector_indexer.py`: Мокировать `QdrantClient`, `DatabaseManager`. Проверить логику `index_problems`.
        *   **Тесты (Integration):**
            *   `indexer-service/tests/integration/test_indexing_pipeline.py`: Мокировать `DatabaseManager` (чтение задач), `QdrantClient` (запись векторов). Проверить полный цикл `scripts/index_problems.py` (или API эндпоинта).
    *   **Acceptance:** `indexer-service` имеет юнит- и интеграционные тесты.

