



#### **Задача 15: Обновить `api/endpoints/block.py`, использовать `common`. (Детализация)**

**Цель:** Обновить эндпоинт получения задачи.

**Действия:**

1.  **Копирование `api/endpoints/block.py` в `web-api-service`:**
    *   **Команда:** `cp api/endpoints/block.py web-api-service/api/endpoints/`
    *   **Обновление импортов в `api/endpoints/block.py`:**
        ```python
        from fastapi import APIRouter, Depends, HTTPException
        from web_api_service.database.database_manager import DatabaseManager # Импортируем из web-api-service
        from common.models.pydantic_models import ProblemResponse # Импортируем из common
        from common.utils.model_adapter import db_problem_to_problem # Импортируем из common, если нужно
        from api.dependencies import get_db_manager, require_subscription # Импортируем зависимости из web-api-service
        import logging

        logger = logging.getLogger(__name__)

        router = APIRouter()

        @router.get("/problem/{problem_id}", response_model=ProblemResponse)
        async def get_problem_data_endpoint(
            problem_id: str,
            db_manager: DatabaseManager = Depends(get_db_manager),
            _: bool = Depends(require_subscription) # Проверка подписки
        ) -> ProblemResponse:
            try:
                # Получить задачу из Supabase (через db_manager)
                # db_problem = await db_manager.get_problem_by_id(problem_id) # Предполагаем, что метод есть и возвращает DBProblem
                # if not db_problem:
                #    raise HTTPException(status_code=404, detail="Problem not found")

                # Преобразовать ORM модель в Pydantic модель (если нужно, используя адаптер)
                # problem = db_problem_to_problem(db_problem) # Используем функцию из common

                # Вернуть задачу
                # return ProblemResponse(problem=problem)
                pass # Заглушка - реализуйте логику получения из Supabase
            except Exception as e:
                logger.error(f"Error in get_problem_data_endpoint: {e}")
                raise HTTPException(status_code=500, detail="Internal server error during getting problem data")
        ```

2.  **Копирование `common` в `web-api-service` (если не копируется в Dockerfile):**
    *   **Команда:** `cp -r common web-api-service/`

**Acceptance:**

*   Файл `web-api-service/api/endpoints/block.py` обновлен.
*   Он импортирует `DatabaseManager` из `web-api-service/database/database_manager.py`.
*   Он импортирует `ProblemResponse` из `common.models.pydantic_models`.
*   Он импортирует `db_problem_to_problem` из `common.utils.model_adapter` (если используется).
*   Он импортирует `get_db_manager`, `require_subscription` из `web-api-service/api/dependencies.py`.
*   Эндпоинт `/problem/{problem_id}` использует `DatabaseManager` для получения задачи из Supabase и проверяет подписку.

---


*   **Задача 15 (обновленная): Обновить `api/endpoints/block.py`.**
    *   **Дополнительное действие:** После обновления `api/endpoints/block.py`:
        *   **Тесты (Integration):** `web-api-service/tests/integration/test_api/test_block_endpoint.py`
            *   Использовать `TestClient`.
            *   Мокировать `DatabaseManager`.
            *   Проверить эндпоинт `/problem/{problem_id}`.
        *   **Acceptance:** Эндпоинт получения задачи покрыт интеграционным тестом.

---
