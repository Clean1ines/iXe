# Архитектурный документ проекта FIPI Core API (IXE)

## 1. Обзор

Этот документ описывает текущую архитектуру приложения `FIPI Core API`, предназначенного для подготовки к ЕГЭ. Приложение реализует RESTful API для доступа к задачам из открытого банка ФИПИ, обработки HTML-контента, генерации викторин и проверки ответов.

### 1.1 Назначение

- Централизованное API для доступа к задачам ЕГЭ.
- Обработка и извлечение данных из HTML-страниц ФИПИ.
- Генерация интерактивных викторин.
- Проверка пользовательских ответов.
- Обеспечение высокой наблюдаемости системы.

### 1.2 Стек технологий

- **Язык программирования:** Python 3.12
- **Веб-фреймворк:** FastAPI
- **ORM:** SQLAlchemy
- **Векторная БД:** Qdrant
- **Автоматизация браузера:** Playwright
- **Логирование:** structlog
- **Трейсинг:** OpenTelemetry (частично интегрирован)
- **Контейнеризация:** Docker (предполагается)

## 2. Архитектурные принципы

- **Чистая архитектура (Clean Architecture):** Слой Presentation зависит от слоя Service, а Service - от Domain. Инфраструктура (Infrastructure) зависит от слоя Domain.
- **Принцип инверсии зависимостей (Dependency Inversion Principle):** Модули верхних уровней не зависят от модулей нижних уровней. Оба зависят от абстракций. Используются интерфейсы (`IExternalChecker`, `IHTMLProcessor`, `IBrowserResource`).
- **Инъекция зависимостей (Dependency Injection):** Используется для настройки компонентов и повышения тестируемости.
- **Наблюдаемость:** Структурированное логирование, централизованное управление ошибками, трейсинг запросов, health checks.

## 3. Структура проекта

```
iXe/
├── api/                    # Слой Presentation (FastAPI endpoints, dependencies)
│   ├── app.py             # Основное приложение FastAPI
│   ├── dependencies.py    # Функции DI для сервисов
│   └── endpoints/         # Роуты API
├── services/              # Слой Service (бизнес-логика)
│   ├── answer_service.py
│   └── quiz_service.py
├── domain/                # Слой Domain (бизнес-объекты, исключения, сервисы)
│   ├── exceptions/        # Иерархия доменных исключений
│   └── services/          # Доменные сервисы (например, наблюдаемость)
├── models/                # Модели данных (Pydantic, SQLAlchemy)
├── processors/            # Слой Infrastructure (обработка HTML)
│   ├── block_processor.py
│   ├── page_processor.py
│   └── html/             # Конкретные HTML-процессоры
├── resource_management/   # Слой Infrastructure (управление ресурсами)
│   ├── browser_manager.py
│   └── browser_pool_manager.py
├── utils/                # Утилиты (логирование, БД, и т.д.)
├── config/               # Конфигурационные файлы
├── data/                 # Данные спецификаций и т.п.
├── docs/                 # Документация
└── tests/                # Тесты
```

## 4. Архитектурные слои

### 4.1 Presentation (api/)

**Ответственность:**
- Определение маршрутов API (endpoints).
- Валидация входных данных (Pydantic).
- Обработка HTTP-запросов и формирование ответов.
- Инъекция зависимостей сервисов.

**Ключевые компоненты:**
- `api/app.py`: Создание экземпляра FastAPI, настройка middleware, lifespan, обработчиков исключений.
- `api/dependencies.py`: Функции, предоставляющие экземпляры сервисов для DI.
- `api/endpoints/`: Файлы с маршрутами (`subjects`, `quiz`, `answer` и т.д.).

### 4.2 Service (services/)

**Ответственность:**
- Реализация основной бизнес-логики приложения.
- Взаимодействие с другими слоями (Domain, Infrastructure).
- Оркестрация операций.

**Ключевые компоненты:**
- `services/answer_service.py`: Логика проверки ответов.
- `services/quiz_service.py`: Логика генерации викторин.
- `BaseService`: Абстрактный базовый класс для сервисов.

### 4.3 Domain (domain/)

**Ответственность:**
- Определение бизнес-объектов и правил.
- Хранение доменных исключений.
- Определение абстракций для инфраструктурных зависимостей (портов).

**Ключевые компоненты:**
- `domain/exceptions/`: Иерархия исключений (`BaseDomainException`, `ValidationException`, `ResourceNotFoundException`, `ExternalServiceException`).
- `domain/services/`: Сервисы, специфичные для домена (например, `ObservabilityService`).

### 4.4 Infrastructure (processors/, resource_management/, utils/)

**Ответственность:**
- Взаимодействие с внешними системами (базы данных, векторные хранилища, браузеры).
- Реализация абстракций, определенных в слое Domain (адаптеры).
- Обработка данных (например, HTML).
- Управление ресурсами.

**Ключевые компоненты:**
- `resource_management/`: Управление браузерными ресурсами (`BrowserManager`, `BrowserPoolManager`, `IBrowserResource`).
- `processors/`: Обработка HTML (`BlockProcessor`, `PageProcessingOrchestrator`, `IHTMLProcessor`, pipeline).
- `utils/database_manager.py`: Взаимодействие с БД.
- `utils/logging_config.py`: Конфигурация `structlog`.
- `utils/retriever.py`: Работа с Qdrant.

## 5. Ключевые архитектурные изменения

### 5.1 Внедрение слоя сервисов с DI и интерфейсами

- **Проблема:** Жесткая связанность, сложность тестирования.
- **Решение:** Создание слоя `services/`, абстрактного `BaseService`, интерфейсов для внешних зависимостей (`IExternalChecker`, `ICacheProvider`, `IStorageProvider`). Использование DI в `dependencies.py`.
- **Преимущества:** Лучшая тестируемость, модульность, соблюдение ISP и DIP.

### 5.2 Миграция управления браузером к ресурс-менеджменту

- **Проблема:** Централизованное управление браузерными ресурсами, отсутствие контроля за жизненным циклом, потенциальные утечки.
- **Решение:** Создание пакета `resource_management`, интерфейса `IBrowserResource`, пула ресурсов `BrowserResourcePool`, шаблона Circuit Breaker, мониторинга ресурсов.
- **Преимущества:** Изоляция ресурсов, улучшенная отказоустойчивость, предотвращение утечек.

### 5.3 Архитектурная реорганизация обработки HTML

- **Проблема:** Нарушение границ слоев, бизнес-логика в HTML-процессорах.
- **Решение:** Создание доменного слоя `domain/services/` (TaskClassificationService, AnswerTypeService, MetadataExtractionService), интерфейса `IHTMLProcessor`, pipeline обработки.
- **Преимущества:** Чистая архитектура, тестируемость, разделение ответственности.

### 5.4 Системная реорганизация обработки ошибок и логирования

- **Проблема:** Разрозненная обработка ошибок, отсутствие структурированного логирования, плохая наблюдаемость.
- **Решение:** Создание иерархии доменных исключений, `ObservabilityService`, `AlertService`, middleware для трейсинга, health checks.
- **Преимущества:** Централизованная обработка ошибок, структурированные логи с контекстом, улучшенная диагностика и мониторинг.

## 6. Потоки выполнения (Примеры)

### 6.1 Получение задачи для викторины

1.  Клиент вызывает `GET /api/quiz/start`.
2.  `api/endpoints/quiz.py` получает запрос.
3.  FastAPI инжектирует `QuizService` через `api/dependencies.py`.
4.  `QuizService` использует `QdrantProblemRetriever` и `InMemorySkillGraph` для выбора задач.
5.  `QuizService` возвращает список задач клиенту.
6.  Запрос логируется через `LoggingMiddleware`.

### 6.2 Проверка ответа пользователя

1.  Клиент вызывает `POST /api/answer/check`.
2.  `api/endpoints/answer.py` получает запрос и инжектирует `AnswerService`.
3.  `AnswerService` вызывает `FIPIAnswerChecker` для проверки.
4.  `FIPIAnswerChecker` использует `BrowserManager` из `resource_management` для доступа к сайту ФИПИ.
5.  Результат проверки сохраняется (опционально) и возвращается клиенту.
6.  Любые ошибки обрабатываются через глобальные обработчики и логируются через `ObservabilityService`.

## 7. Наблюдаемость

- **Логирование:** Структурированное логирование с `structlog`. Включает Trace ID, уровень, сообщение, контекст.
- **Алертинг:** `AlertService` для отправки уведомлений о критических ошибках.
- **Health Checks:** `/health` и `/health/browser-resources` для проверки состояния зависимостей.
- **Трейсинг:** Интеграция с OpenTelemetry (частично).

## 8. Тестирование

- **Юнит-тесты:** Для логики в сервисах и доменных объектах.
- **Интеграционные тесты:** Для проверки взаимодействия между слоями.
- **Тесты на архитектуру:** Для проверки соблюдения зависимостей (пока не реализованы, но планируются).

